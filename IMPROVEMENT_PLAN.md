# План улучшения стратегии ритривера для достижения Total Score 2.3+

## Анализ текущей ситуации

### Версия 620de85 (базовая, лучшая производительность)
- **Total Score**: 2.104 (C - Fair)
- **Конфигурация**:
  - `top_percent`: 0.20 (20% файлов)
  - `local_model_path`: null (используется all-MiniLM-L6-v2)
  - НЕТ multiplier для `selected_count`
  - Простые пропорции: L1=60%, L2=30%, L3=10% для архитектурных задач
  - Простой boost: 0.12 за ключевые слова, 0.18 за паттерны
  - НЕТ quality filter
  - НЕТ расширенного поиска зависимостей (co-location, similar-name)

### Последняя версия (деградация)
- **Total Score**: 2.067 (C - Fair)
- **Проблемы**:
  - Слишком агрессивные изменения привели к ухудшению
  - Quality filter может быть слишком строгим
  - Multiplier 1.5x может создавать переполнение промпта
  - Сложные fallback стратегии могут добавлять шум

## Ключевые инсайты из анализа

### Что работало хорошо в 620de85:
1. **Простота**: Простые пропорции без излишних усложнений
2. **Баланс**: Хороший баланс между семантикой и зависимостями
3. **Стабильность**: Нет переполнения промпта
4. **Базовая архитектурная поддержка**: Простой boost работает

### Что не работало в последних версиях:
1. **Слишком агрессивные multipliers**: 1.5x-2.0x создают переполнение
2. **Quality filter**: Может отфильтровывать важные файлы
3. **Сложные fallback стратегии**: Добавляют шум вместо пользы
4. **Переусложнение**: Слишком много эвристик одновременно

## Стратегия улучшения для достижения 2.3+

### Фаза 1: Инкрементальные улучшения на базе 620de85

#### 1.1 Улучшение архитектурного boost (консервативно)
- **Текущее**: boost 0.12 за ключевые слова, 0.18 за паттерны
- **Предложение**: 
  - Увеличить boost до 0.15 за ключевые слова (было 0.12)
  - Увеличить boost до 0.22 за паттерны (было 0.18)
  - Добавить boost 0.10 за файлы с высоким similarity (>0.25)
  - Добавить boost 0.10 за файлы, упомянутые в промпте
- **Ожидаемый эффект**: +0.05-0.10 балла для архитектурных задач

#### 1.2 Улучшение поиска зависимостей (умеренно)
- **Текущее**: Только прямые и обратные зависимости
- **Предложение**: 
  - Добавить co-location heuristic (файлы в той же директории) - до 20% от Level 2
  - Добавить similar-name heuristic (похожие имена файлов) - до 15% от Level 2
  - НЕ использовать эти эвристики для архитектурных задач (они уже имеют хорошие зависимости)
- **Ожидаемый эффект**: +0.03-0.05 балла для code comprehension и feature implementation

#### 1.3 Оптимизация пропорций (минимальные изменения)
- **Текущее**: L1=60%, L2=30%, L3=10% для архитектурных задач
- **Предложение**:
  - Архитектурные: L1=55%, L2=35%, L3=10% (больше зависимостей)
  - Code comprehension: L1=65%, L2=30%, L3=5% (больше зависимостей для трассировки)
  - Остальные: без изменений
- **Ожидаемый эффект**: +0.02-0.04 балла

#### 1.4 Использование локальной модели VESO (осторожно)
- **Текущее**: all-MiniLM-L6-v2
- **Предложение**: 
  - Использовать VESO-30alpha3 с `trust_remote_code=True`
  - НО: не менять другие параметры одновременно
  - Тестировать отдельно
- **Ожидаемый эффект**: +0.05-0.15 балла (если модель лучше)

### Фаза 2: Адаптивные улучшения (после проверки Фазы 1)

#### 2.1 Умный multiplier (только если нет переполнения)
- **Идея**: Использовать multiplier только для code comprehension (1.2x)
- **Условие**: Только если промпт не превышает 90% max_context_tokens
- **Ожидаемый эффект**: +0.03-0.05 балла для code comprehension

#### 2.2 Улучшенный chunking для архитектурных задач
- **Идея**: Для архитектурных задач приоритизировать первые 3-4 чанка (определения классов)
- **Текущее**: Уже есть приоритизация первых чанков
- **Улучшение**: Увеличить boost для первых чанков до 0.08 (было 0.05)
- **Ожидаемый эффект**: +0.02-0.03 балла

#### 2.3 Динамический top_percent
- **Идея**: Использовать разные top_percent для разных типов задач
  - Архитектурные: 0.22 (вместо 0.20)
  - Code comprehension: 0.25 (вместо 0.20)
  - Остальные: 0.20
- **Ожидаемый эффект**: +0.02-0.04 балла

### Фаза 3: Продвинутые улучшения (только если Фазы 1-2 успешны)

#### 3.1 Ранжирование зависимостей по релевантности
- **Идея**: Ранжировать найденные зависимости по их similarity к промпту
- **Реализация**: Вычислять similarity для зависимостей и сортировать
- **Ожидаемый эффект**: +0.03-0.05 балла

#### 3.2 Контекстно-зависимый boost
- **Идея**: Увеличивать boost для файлов, которые связаны с несколькими выбранными файлами
- **Реализация**: Если файл имеет зависимости с 2+ выбранными файлами, добавить boost 0.08
- **Ожидаемый эффект**: +0.02-0.04 балла

## План реализации (пошагово)

### Шаг 1: Базовая версия с улучшенным boost
1. Взять версию 620de85
2. Улучшить архитектурный boost (1.1)
3. Протестировать
4. **Цель**: 2.15-2.20

### Шаг 2: Добавить улучшенный поиск зависимостей
1. Добавить co-location и similar-name heuristics (1.2)
2. Протестировать
3. **Цель**: 2.20-2.25

### Шаг 3: Оптимизировать пропорции
1. Изменить пропорции (1.3)
2. Протестировать
3. **Цель**: 2.25-2.30

### Шаг 4: Тестирование VESO модели
1. Включить VESO-30alpha3 (1.4)
2. Протестировать отдельно
3. Если лучше - использовать, если нет - вернуться к all-MiniLM-L6-v2
4. **Цель**: 2.30+

### Шаг 5: Адаптивные улучшения (если нужно)
1. Добавить умный multiplier (2.1)
2. Улучшить chunking (2.2)
3. Динамический top_percent (2.3)
4. **Цель**: 2.35+

## Метрики успеха

- **Минимальная цель**: Total Score >= 2.30
- **Целевая цель**: Total Score >= 2.35
- **Идеальная цель**: Total Score >= 2.40

### Категории для мониторинга:
1. **Architectural Understanding**: Должна улучшиться с улучшенным boost
2. **Code Comprehension**: Должна улучшиться с расширенным поиском зависимостей
3. **Security Analysis**: Должна остаться стабильной или улучшиться
4. **Feature Implementation**: Должна улучшиться с расширенным поиском зависимостей

## Риски и митигация

### Риск 1: Переполнение промпта
- **Митигация**: Не использовать агрессивные multipliers, мониторить размер промпта
- **Откат**: Вернуться к версии без multipliers

### Риск 2: Деградация архитектурных задач
- **Митигация**: Тестировать каждое изменение отдельно
- **Откат**: Вернуться к простому boost из 620de85

### Риск 3: Слишком много зависимостей (шум)
- **Митигация**: Ограничить количество зависимостей через max_dependent_files
- **Откат**: Убрать co-location и similar-name heuristics

## Приоритеты

1. **Высокий приоритет**: Улучшение архитектурного boost (1.1)
2. **Высокий приоритет**: Тестирование VESO модели (1.4)
3. **Средний приоритет**: Улучшение поиска зависимостей (1.2)
4. **Средний приоритет**: Оптимизация пропорций (1.3)
5. **Низкий приоритет**: Адаптивные улучшения (Фаза 2-3)

## Заключение

Стратегия основана на инкрементальных улучшениях проверенной версии 620de85. Каждое изменение будет тестироваться отдельно, чтобы понять его влияние. Основной фокус - на улучшении архитектурного boost и расширении поиска зависимостей, при сохранении простоты и стабильности базовой версии.
