# План улучшения ретривера для достижения скор 2.3

## Текущая ситуация
- **Текущий скор**: 1.998 (F - Poor)
- **Целевой скор**: 2.3 (C - Fair)
- **Требуемое улучшение**: +15.1%

## Результаты по категориям
1. **Architectural Understanding**: 1.846 (самый низкий)
2. **Code Comprehension**: 1.938
3. **Security Analysis**: 2.102
4. **Feature Implementation**: 2.107 (самый высокий)

## Предлагаемые методы улучшения

### 1. Улучшение Query Expansion для модели qwen3-coder
**Проблема**: Модель qwen3-coder может требовать более специфичных запросов с техническими терминами.

**Решение**:
- Увеличить количество синонимов в `_expand_query_for_retrieval`
- Добавить больше технических терминов для каждой категории задач
- Использовать более агрессивное расширение запросов (больше терминов)

**Изменения**:
- Увеличить количество синонимов с 2 до 4-5 для каждого ключевого слова
- Добавить больше доменных терминов для каждой категории задач
- Расширить словарь синонимов для архитектурных и comprehension задач

### 2. Улучшение Multi-Query Retrieval
**Проблема**: Текущая реализация генерирует 5 запросов, но может быть недостаточно разнообразных вариантов.

**Решение**:
- Увеличить количество вариантов запросов с 5 до 7-8
- Добавить больше стратегий переформулирования:
  - Технический фокус (для implementation)
  - Вопросный формат (для comprehension)
  - Архитектурный фокус (для architectural)
  - Безопасность фокус (для security)
- Улучшить веса для разных типов запросов

**Изменения**:
- Увеличить `num_queries` с 5 до 8
- Добавить специализированные стратегии для каждой категории задач
- Настроить веса запросов: оригинальный = 1.0, специализированные = 0.9, остальные = 0.7

### 3. Улучшение Hybrid Search баланса
**Проблема**: Текущий `hybrid_alpha=0.75` может быть слишком смещен в сторону semantic search.

**Решение**:
- Для разных типов задач использовать разные значения `hybrid_alpha`:
  - Architectural: 0.65 (больше BM25 для точных совпадений)
  - Comprehension: 0.70 (баланс)
  - Security: 0.80 (больше semantic для концептуального поиска)
  - Implementation: 0.75 (текущее значение)
- Улучшить нормализацию scores для лучшего баланса

**Изменения**:
- Адаптивный `hybrid_alpha` в зависимости от типа задачи
- Улучшенная нормализация с использованием softmax-like transformation

### 4. Увеличение количества файлов для архитектурных задач
**Проблема**: Architectural Understanding имеет самый низкий скор (1.846).

**Решение**:
- Увеличить `top_percent` для architectural tasks с 0.40 до 0.50
- Увеличить multiplier с 1.40 до 1.60
- Увеличить `max_context_tokens` для architectural с 150000 до 180000

**Изменения**:
- `architectural_multiplier`: 1.40 → 1.60
- `effective_top_percent` для architectural: 0.40 → 0.50
- `effective_max_context` для architectural: 150000 → 180000

### 5. Улучшение Chunking Strategy
**Проблема**: Текущая стратегия chunking может пропускать важные части файлов.

**Решение**:
- Для comprehension задач: увеличить `chunks_per_file` с 8 до 10
- Для architectural задач: использовать больше первых чанков (первые 5-6 чанков вместо 3-4)
- Улучшить diversification strategy: выбирать чанки из большего количества регионов файла

**Изменения**:
- `chunks_per_file` для comprehension: 8 → 10
- Количество первых чанков для architectural: 3-4 → 5-6
- Количество регионов для diversification: 3 → 4-5

### 6. Улучшение Dependency Graph Expansion
**Проблема**: Текущая глубина expansion может быть недостаточной для сложных задач.

**Решение**:
- Увеличить `max_depth` для architectural tasks с 2 до 3
- Увеличить `max_files_per_level` с 20 до 25 для architectural
- Улучшить разрешение зависимостей: анализировать больше контента файла (с 2000 до 3000 символов)

**Изменения**:
- `max_depth` для architectural: 2 → 3
- `max_files_per_level` для architectural: 20 → 25
- Размер анализа для dependency extraction: 2000 → 3000 символов

### 7. Улучшение Boosting для разных типов задач
**Проблема**: Текущие boost значения могут быть недостаточными.

**Решение**:
- Увеличить boost для architectural keywords: 0.22 → 0.28
- Увеличить boost для architectural patterns: 0.28 → 0.35
- Добавить специальный boost для comprehension tasks (для файлов с flow-related терминами)
- Добавить boost для security tasks (для файлов с security-related терминами)

**Изменения**:
- Architectural keyword boost: 0.22 → 0.28
- Architectural pattern boost: 0.28 → 0.35
- Добавить comprehension-specific boosting
- Добавить security-specific boosting

### 8. Улучшение Quality Threshold
**Проблема**: Текущий threshold 0.10 может пропускать релевантные файлы.

**Решение**:
- Снизить quality threshold для architectural с 0.10 до 0.08
- Добавить adaptive threshold в зависимости от количества доступных файлов

**Изменения**:
- Quality threshold для architectural: 0.10 → 0.08
- Adaptive threshold: если файлов мало, снижать threshold

### 9. Улучшение RRF (Reciprocal Rank Fusion)
**Проблема**: Текущий k=20 может быть неоптимальным.

**Решение**:
- Уменьшить k с 20 до 15 для большей чувствительности к позиции
- Улучшить комбинирование RRF и similarity scores

**Изменения**:
- RRF k: 20 → 15
- Веса для комбинирования: max_similarity (60%), avg_similarity (30%), RRF (10%) → max_similarity (65%), avg_similarity (25%), RRF (10%)

### 10. Улучшение Level Ratios для разных типов задач
**Проблема**: Текущие ratios могут быть неоптимальными для новой модели.

**Решение**:
- Architectural: L1=55%, L2=35%, L3=10% → L1=50%, L2=40%, L3=10% (больше зависимостей)
- Comprehension: L1=65%, L2=30%, L3=5% → L1=60%, L2=35%, L3=5% (больше зависимостей для tracing)
- Security: L1=70%, L2=20%, L3=10% → L1=75%, L2=15%, L3=10% (больше semantic)
- Implementation: L1=75%, L2=15%, L3=10% → L1=70%, L2=20%, L3=10% (больше зависимостей)

**Изменения**:
- Адаптивные ratios в зависимости от типа задачи и результатов

## Приоритетность внедрения

### Высокий приоритет (ожидаемый эффект: +0.15-0.20 скор)
1. Улучшение Query Expansion (#1)
2. Увеличение количества файлов для architectural (#4)
3. Улучшение Hybrid Search баланса (#3)
4. Улучшение Multi-Query Retrieval (#2)

### Средний приоритет (ожидаемый эффект: +0.05-0.10 скор)
5. Улучшение Chunking Strategy (#5)
6. Улучшение Dependency Graph Expansion (#6)
7. Улучшение Boosting (#7)

### Низкий приоритет (ожидаемый эффект: +0.02-0.05 скор)
8. Улучшение Quality Threshold (#8)
9. Улучшение RRF (#9)
10. Улучшение Level Ratios (#10)

## Ожидаемый результат
После внедрения всех улучшений ожидается:
- **Architectural Understanding**: 1.846 → 2.1-2.2 (+13-19%)
- **Code Comprehension**: 1.938 → 2.15-2.25 (+11-16%)
- **Security Analysis**: 2.102 → 2.25-2.35 (+7-12%)
- **Feature Implementation**: 2.107 → 2.3-2.4 (+9-14%)
- **Общий скор**: 1.998 → 2.25-2.35 (+12.6-17.6%)

## Риски и митигация
1. **Риск**: Увеличение количества файлов может привести к превышению context limit
   - **Митигация**: Использовать smart chunking и увеличить max_context_tokens
2. **Риск**: Увеличение сложности может замедлить ретривер
   - **Митигация**: Оптимизировать dependency graph building (использовать fast version)
3. **Риск**: Изменения могут негативно повлиять на другие категории
   - **Митигация**: Использовать адаптивные параметры в зависимости от типа задачи
